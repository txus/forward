# Point clangd at the clangd-specific build directory
CompileFlags:
  CompilationDatabase: build/clangd

# Regular C++ files - explicitly remove any CUDA flags that might be inferred
---
If:
  PathMatch: .*\.(cpp|hpp|h)$
CompileFlags:
  Remove:
    - -xcuda
    - -x cuda
    - --cuda-gpu-arch=*
    - --cuda-host-only
    - --cuda-device-only
    - -fcuda-is-device
    - --offload-arch=*
    - -fgpu-rdc
  Add:
    - -xc++

# CUDA kernel files (device code) - analyze with device-only mode
# These contain __global__ functions that run on GPU
---
If:
  PathMatch: .*/kernels/.*\.cu$
CompileFlags:
  Remove:
    - --expt-relaxed-constexpr
    - -Xcompiler=*
    - -G
  Add:
    - -xcuda
    - --cuda-gpu-arch=sm_120
    - --cuda-device-only

Diagnostics:
  Suppress:
    - variadic_device_fn
    - attributes_not_allowed
    - note_previous_decl

# CUDA kernel headers - also device code
---
If:
  PathMatch: .*/kernels/.*\.cuh$
CompileFlags:
  Remove:
    - --expt-relaxed-constexpr
    - -Xcompiler=*
    - -G
  Add:
    - -xcuda
    - --cuda-gpu-arch=sm_120
    - --cuda-device-only

Diagnostics:
  Suppress:
    - variadic_device_fn
    - attributes_not_allowed

# CUDA host files (kernel launchers, memory management) - analyze with host-only mode
# These contain code that runs on CPU and calls kernels
---
If:
  PathMatch: .*\.cu$
  PathExclude: .*/kernels/.*
CompileFlags:
  Remove:
    - --expt-relaxed-constexpr
    - -Xcompiler=*
    - -G
  Add:
    - -xcuda
    - --cuda-gpu-arch=sm_120
    - --cuda-host-only

Diagnostics:
  Suppress:
    - variadic_device_fn
    - attributes_not_allowed
    # clangd has issues resolving some templates in CUDA host-only mode
    # These are false positives - the actual Clang build succeeds
    - ovl_no_viable_function_in_call
    - no_member
    - template_arg_list_constraints_not_satisfied
    # ODR violations from CUDA host/device compilation seeing headers differently
    - module_odr_violation_function
    - module_odr_violation_definition
    # __noinline__ macro conflict between CUDA and libstdc++
    - undeclared_var_use_suggest
    - typename_invalid_functionspec
    - expected_expression
    - note_previous_decl

# CUDA utility headers (non-kernel) - host code
---
If:
  PathMatch: .*\.cuh$
  PathExclude: .*/kernels/.*
CompileFlags:
  Remove:
    - --expt-relaxed-constexpr
    - -Xcompiler=*
    - -G
  Add:
    - -xcuda
    - --cuda-gpu-arch=sm_120
    - --cuda-host-only

Diagnostics:
  Suppress:
    - variadic_device_fn
    - attributes_not_allowed
